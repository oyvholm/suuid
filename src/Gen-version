#!/bin/sh

#==============================================================================
# Gen-version
# File ID: a0ae4d34-b311-11e6-8b72-279c2a0468a3
#
# Generate version.h
#
# Author: Ã˜yvind A. Holm <sunny@sunbase.org>
# License: GNU General Public License version 2 or later.
#==============================================================================

progname=Gen-version

suuid_version=0.4.0
suuid_date=2016-12-02

tag_prefix="suuid-v$suuid_version"
has_git=$(git --version | grep -q "git version" && echo 1 || echo 0)

if test -d ../.git -a $has_git -eq 1; then
	if git tag | grep -q ^$tag_prefix; then
		numsince=$(
		    git log --format=%h \
		        $tag_prefix.. 2>/dev/null |
		    wc -l |
		    tr -d '\t '
		).
	else
		numsince=''
	fi
	gitsha=$(git rev-parse --short=12 HEAD)
	test -n "$(git diff-index --name-only HEAD)" &&
		gitsha="$gitsha-dirty"
	suuid_fullversion="$suuid_version+${numsince}git-$gitsha"
	suuid_date=$(git log -1 --format=%ci | cut -c -10)
else
	suuid_fullversion=$suuid_version
fi

cat <<END >version.h
/* Generated by $progname */
#define SUUID_VERSION  "$suuid_fullversion"
#define SUUID_DATE  "$suuid_date"
END

exit 0

# vim: set ts=8 sw=8 sts=8 noet fo+=w tw=79 fenc=UTF-8 :
